<script>
/*
====================================================
GAS ì—°ë™ ì„¤ì •
====================================================
*/
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwpSozgc7HLppUUtOrx7WCupUzmn_q5p-bZzhj_pdluhH9GHnv5ZuFalWiLoGbItDSS/exec";

const nicknameEl = document.getElementById("nickname");
const visitEl = document.getElementById("visit");
const orderBtn = document.getElementById("orderBtn");
const copyBtn = document.getElementById("copyBtn");
const orderText = document.getElementById("orderText");

/* ìˆ˜ëŸ‰ ì¡°ì ˆ (ë³€ê²½ ì—†ìŒ) */
document.querySelectorAll(".product").forEach(p => {
  const qtyEl = p.querySelector(".qty");
  p.querySelector(".plus").onclick = () => {
    qtyEl.innerText = Number(qtyEl.innerText) + 1;
    calc();
  };
  p.querySelector(".minus").onclick = () => {
    qtyEl.innerText = Math.max(0, Number(qtyEl.innerText) - 1);
    calc();
  };
});

function calc() {
  let sum = 0;
  document.querySelectorAll(".product").forEach(p => {
    sum += Number(p.dataset.price) * Number(p.querySelector(".qty").innerText);
  });
  document.getElementById("total").innerText = sum.toLocaleString();
}

/* ì£¼ë¬¸ ì „ì†¡ */
orderBtn.onclick = async () => {
  const nickname = nicknameEl.value.trim();
  const visit = visitEl.value;

  if (!nickname || !visit) {
    alert("ë‹‰ë„¤ìž„ê³¼ ìˆ˜ë ¹ì¼ì„ ìž…ë ¥í•˜ì„¸ìš”");
    return;
  }

  let items = [];
  let total = 0;

  document.querySelectorAll(".product").forEach(p => {
    const qty = Number(p.querySelector(".qty").innerText);
    if (qty > 0) {
      const price = Number(p.dataset.price);
      items.push({
        name: p.querySelector(".name").innerText,
        qty,
        price
      });
      total += price * qty;
    }
  });

  if (!items.length) {
    alert("ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”");
    return;
  }

  let result;
  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nickname, visit, items, total })
    });
    result = await res.json();
  } catch (err) {
    alert("ì£¼ë¬¸ ì €ìž¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    return;
  }

  if (result.result !== "success") {
    alert("ì£¼ë¬¸ ì €ìž¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nê´€ë¦¬ìžì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.");
    return;
  }

  /* ì£¼ë¬¸ë¬¸êµ¬ ìƒì„± */
  orderText.value =
`${nickname}ë‹˜ ì£¼ë¬¸ë‚´ì—­
${items.map(i => `- ${i.name} ${i.qty}ê°œ`).join("\n")}
ì´ ${total.toLocaleString()}ì› ìž…ê¸ˆ ë¶€íƒë“œë¦½ë‹ˆë‹¤ ðŸ˜Š`;

  orderText.style.display = "block";
  copyBtn.style.display = "block";
  orderBtn.disabled = true;
};

/* ë³µì‚¬ */
copyBtn.onclick = () => {
  orderText.select();
  document.execCommand("copy");
  alert("ë³µì‚¬ ì™„ë£Œ");
};
</script>
