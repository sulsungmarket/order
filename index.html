<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>설성푸드 공동구매 주문서</title>

  <!--
  ====================================================
  설성푸드 공동구매 HTML 주문서
  ====================================================

  VERSION HISTORY

  v1.0.0
  - 단일 상품 주문 구조

  v1.1.0
  - 상품 복수 선택 구조로 변경 (items[])

  v1.2.0
  - GAS POST + JSON 연동

  v1.3.0
  - validation 강화
  - 콘솔 로그 추가

  v1.4.0 (MASTER)
  - SCRIPT_URL 명시
  - 상품 배열 복구
  - 기존 구조 유지 (삭제 없음)

  ====================================================
  -->
</head>

<body>
  <h1>설성푸드 공동구매 주문</h1>

  <!-- 닉네임 -->
  <label>
    닉네임:
    <input type="text" id="nickname" />
  </label>
  <br /><br />

  <!-- 방문일 -->
  <label>
    방문일:
    <input type="date" id="visit" />
  </label>
  <br /><br />

  <!-- 상품 목록 -->
  <h3>상품 선택</h3>

  <label>
    <input type="checkbox" class="product" data-name="등심" data-price="30000" />
    등심 (30,000원)
    수량:
    <input type="number" class="qty" min="1" value="1" />
  </label>
  <br />

  <label>
    <input type="checkbox" class="product" data-name="안심" data-price="35000" />
    안심 (35,000원)
    수량:
    <input type="number" class="qty" min="1" value="1" />
  </label>
  <br />

  <label>
    <input type="checkbox" class="product" data-name="채끝" data-price="32000" />
    채끝 (32,000원)
    수량:
    <input type="number" class="qty" min="1" value="1" />
  </label>

  <br /><br />

  <button onclick="submitOrder()">주문 완료</button>

  <!-- ================= SCRIPT ================= -->
  <script>
    /**
     * ====================================================
     * ⚠️ GAS WEB APP URL (절대 삭제 금지)
     * ====================================================
     */
    const SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbxsNctvxZ-DA8y7WjhapsuiRfu0iMM_HM9d7jYyff8/dev";

    /**
     * ====================================================
     * 주문 전송 함수
     * ====================================================
     */
    function submitOrder() {
      console.log("주문 버튼 클릭");

      const nickname = document.getElementById("nickname").value.trim();
      const visit = document.getElementById("visit").value;

      if (!nickname || !visit) {
        alert("닉네임과 방문일을 입력하세요.");
        return;
      }

      const products = document.querySelectorAll(".product");
      const qtyInputs = document.querySelectorAll(".qty");

      const items = [];
      let total = 0;

      products.forEach((product, index) => {
        if (product.checked) {
          const name = product.dataset.name;
          const price = Number(product.dataset.price);
          const qty = Number(qtyInputs[index].value);

          if (qty <= 0) return;

          items.push({
            name: name,
            qty: qty,
            price: price
          });

          total += qty * price;
        }
      });

      if (items.length === 0) {
        alert("상품을 선택하세요.");
        return;
      }

      const payload = {
        nickname: nickname,
        visit: visit,
        items: items,
        total: total
      };

      console.log("전송 payload", payload);

      fetch(SCRIPT_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      })
        .then(res => res.json())
        .then(result => {
          console.log("GAS 응답", result);

          if (result.result === "success") {
            alert("주문이 정상적으로 접수되었습니다.");
          } else {
            alert("주문 전송 실패. 다시 시도하세요.");
          }
        })
        .catch(err => {
          console.error("전송 에러", err);
          alert("네트워크 오류 발생");
        });
    }
  </script>
</body>
</html>
